<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Höstlov 2025 – Närvaroanmälan</title>

  <!-- Firebase + EmailJS som tidigare -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>window.onload = () => emailjs.init("64vIY_pmg15yG6lYv");</script>
  <script src="email.js"></script>

  <style>
     /* Basreset och typsnitt */
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: "Source Sans Pro", sans-serif; background:#f5f5f5; color:#333; }

    header {
      background:#003366; color:#fff;
      padding:1rem;
      display:flex; align-items:center; gap:0.75rem;
    }
    header img { height:40px; }
    header h1 { font-size:1.25rem; }

    .info-box {
      background:#fff;
      border-left:4px solid #ffa726;
      margin:1rem;
      padding:1rem;
      border-radius:4px;
      font-size:0.9rem;
      line-height:1.4;
    }
    .info-box h2 {
      color:#003366; font-size:1rem; margin-bottom:0.5rem;
    }

    form {
      background:#fff;
      margin:1rem;
      padding:1rem;
      border-radius:4px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    form label {
      display:block;
      margin-top:0.75rem;
      font-size:0.9rem;
    }
    form input, form textarea {
      width:100%;
      padding:0.6rem;
      margin-top:0.25rem;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:0.9rem;
    }

    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      margin:1rem 0;
    }
    .controls button,
    .controls input[type="time"] {
      flex:1 1 45%;
      padding:0.6rem;
      border:none;
      border-radius:4px;
      font-size:0.9rem;
    }
    .controls button {
      background:#0055a5;
      color:#fff;
    }
    .controls button:hover { background:#004080; }

    .calendar-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:0.5rem;
      margin-bottom:1rem;
    }
    .day-card {
      background:#e3f2fd;
      padding:0.75rem;
      border-radius:4px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:120px;
    }
    .day-card[data-closed] {
      background:#fdecea;
      color:#a94442;
    }
    .day-header { font-weight:600; font-size:0.9rem; color:#003366; }
    .note { font-size:0.85rem; margin:0.5rem 0; flex:1; }

    .toggles {
      display:flex; gap:0.25rem;
    }
    .toggles button {
      flex:1; padding:0.4rem; font-size:0.85rem;
      border:1px solid #ccc; background:#fafafa; border-radius:3px;
    }
    .toggles button.active {
      background:#4a90e2; color:#fff; border-color:#4a90e2;
    }

    .time-inputs {
      display:none; flex-direction:column; gap:0.25rem; margin-top:0.5rem;
    }
    .time-inputs input { font-size:0.85rem; }

    button[type="submit"] {
      width:100%;
      background:#0055a5; color:#fff;
      padding:0.75rem;
      font-size:1rem;
      border:none; border-radius:4px;
    }
    button[type="submit"]:hover { background:#004080; }

    #status {
      text-align:center;
      margin:1rem;
      font-weight:600;
    }

    /* Popup */
    #overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
    #summary-box {
      display:none;
      position:fixed;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      padding:1rem;
      border-radius:4px;
      width:90%; max-width:320px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    #summary-box h2 { margin-bottom:0.5rem; color:#0055a5; font-size:1rem; }
    #summary-box button#close-summary {
      position:absolute; top:0.5rem; right:0.5rem;
      background:transparent; border:none; font-size:1.2rem;
      cursor:pointer;
    }
    #summary-box pre { font-size:0.85rem; white-space:pre-wrap; }

    /* Mobilanpassningar */
    @media (min-width: 600px) {
      .calendar-grid { grid-template-columns:repeat(3,1fr); }
      .controls { gap:1rem; }
      .controls button, .controls input[type="time"] { flex:1; }
    }
  </style>
</head>
<body>

  <header>
    <img src="stockholm-logo.jpg" alt="Stockholms stad logotyp">
    <h1>Höstlov 2025 – Närvaroanmälan</h1>
  </header>

  <div class="info-box">
    <h2>Välkommen!</h2>
    <p><strong>Snart är höstlovet här</strong> och för vår planering behöver vi veta vilka ungdomar som kommer till Smultronet.</p>
    <p>Vi kommer att ha många <strong>uteaktiviteter</strong> under lovet – ta med lämpliga kläder!</p>
    <p><strong>Taxi:</strong> Kontakta skolan för att boka om färdtjänst.</p>
    <p><strong>EJ INLÄMNAD</strong> innebär att din ungdom inte kommer.</p>
    <p><strong>Öppettider:</strong> 09:00–17:00</p>
    <p style="margin-top:0.5rem"><em>personalen på Smultronet</em></p>
  </div>

  <form id="form">
    <label>Vårdnadshavares namn:
      <input type="text" id="parentName" required>
    </label>
    <label>Ungdomens namn:
      <input type="text" id="youthName" required>
    </label>
    <label>Vårdnadshavares e-post:
      <input type="email" id="parentEmail" required>
    </label>
    <label>Övriga kommentarer:
      <textarea id="kommentar" rows="3"></textarea>
    </label>

    <div class="controls">
      <button type="button" id="selectAllYes">Kommer alla</button>
      <button type="button" id="selectAllNo">Kommer ej</button>
      <input type="time" id="globalFrom" value="09:00">
      <input type="time" id="globalTo"   value="17:00">
      <button type="button" id="applyTimes">Tider →</button>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>

    <button type="submit">Skicka närvaro</button>
  </form>

  <p id="status"></p>

  <!-- Popup -->
  <div id="overlay"></div>
  <div id="summary-box">
    <button id="close-summary">×</button>
    <h2>Din sammanfattning</h2>
    <pre id="summary-content"></pre>
  </div>

  <script>
    async function loadCalendar() {
      const snap = await firebase.firestore().collection("kalender").orderBy("date").get();
      const grid = document.getElementById("calendarGrid"); grid.innerHTML = "";
      snap.forEach(doc => {
        const {date,note,color,closed} = doc.data();
        const card = document.createElement("div"); card.className="day-card";
        if(color) card.style.background=color;
        if(closed) card.setAttribute("data-closed","");
        if(closed) {
          card.innerHTML=`<div class="day-header">${date}</div><div class="note">${note}</div>`;
        } else {
          card.innerHTML=`
            <div class="day-header">${date}</div>
            <div class="note">${note}</div>
            <div class="toggles">
              <button class="btn-yes">Kommer</button>
              <button class="btn-no">Kommer ej</button>
            </div>
            <div class="time-inputs">
              <input class="from" type="time" value="09:00">
              <input class="to"   type="time" value="17:00">
            </div>`;
          const yes=card.querySelector(".btn-yes"), no=card.querySelector(".btn-no"), times=card.querySelector(".time-inputs");
          yes.addEventListener("click",()=>{yes.classList.add("active");no.classList.remove("active");times.style.display="flex";});
          no.addEventListener("click",()=>{no.classList.add("active");yes.classList.remove("active");times.style.display="none";});
          yes.dataset.date=no.dataset.date=times.dataset.date=date;
        }
        grid.appendChild(card);
      });
    }
    window.addEventListener("load", loadCalendar);

    document.getElementById("selectAllYes").onclick = ()=>document.querySelectorAll(".btn-yes").forEach(b=>b.click());
    document.getElementById("selectAllNo"). onclick = ()=>document.querySelectorAll(".btn-no"). forEach(b=>b.click());
    document.getElementById("applyTimes").onclick=()=>{
      const from=document.getElementById("globalFrom").value;
      const to  =document.getElementById("globalTo").value;
      document.querySelectorAll(".from").forEach(i=>i.value=from);
      document.querySelectorAll(".to").  forEach(i=>i.value=to);
    };

    document.getElementById("form").addEventListener("submit",async e=>{
      e.preventDefault();
      const pn=document.getElementById("parentName").value;
      const yn=document.getElementById("youthName").value;
      const pe=document.getElementById("parentEmail").value;
      const km=document.getElementById("kommentar").value;
      const svar=Array.from(document.querySelectorAll(".day-card")).map(c=>({
        date:c.querySelector(".btn-yes")?.dataset.date,
        kommer:c.querySelector(".btn-yes")?.classList.contains("active"),
        ejkommer:c.querySelector(".btn-no")?.classList.contains("active"),
        from:c.querySelector(".from")?.value,
        to:c.querySelector(".to")?.value
      }));
      await firebase.firestore().collection("narvaro").add({pn,yn,pe,km,svar,tidpunkt:firebase.firestore.Timestamp.now()});
      let sum=`Ungdom: ${yn}\n\n`+svar.map(s=>`${s.date}: ${s.kommer?"Kommer":s.ejkommer?"Kommer ej":"Osäker"}, från kl ${s.from} till kl ${s.to}`).join("\n");
      if(km.trim()) sum+=`\n\nKommentar: ${km}`;
      const ok=await skickaBekraftelse(pn,pe,yn,sum,km);
      document.getElementById("status").textContent=ok?"✅ Tack! Din anmälan är inskickad.":"⚠️ Fel vid e-post!";
      if(ok){
        document.getElementById("summary-content").textContent=sum;
        document.getElementById("overlay").style.display="block";
        document.getElementById("summary-box").style.display="block";
        document.body.style.overflow="hidden";
        document.getElementById("close-summary").onclick=()=>{
          document.getElementById("overlay").style.display="none";
          document.getElementById("summary-box").style.display="none";
          document.body.style.overflow="";
        };
        e.target.reset();
      }
    });
  </script>

</body>
</html>
