<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontrollrond Smultronet & Electric</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:20px auto; padding:0 15px; color:#333; }
    h1 { color:#005ea6; margin-bottom:10px; }
    .tab { display:flex; border-bottom:2px solid #005ea6; margin-bottom:20px; }
    .tab button { flex:1; background:none; border:none; padding:12px; cursor:pointer; color:#005ea6; border-bottom:3px solid transparent; font-size:16px; transition:.3s; }
    .tab button.active { border-bottom-color:#005ea6; font-weight:bold; }
    .tabcontent { display:none; }
    .tabcontent.active { display:block; }
    .control-point { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:4px; }
    .control-point label { font-weight:bold; display:block; }
    .link-button { background:none; border:none; color:#005ea6; text-decoration:underline; cursor:pointer; font-size:.9em; margin-left:8px; }
    .instructions { display:none; background:#eef7ff; padding:8px; margin-top:6px; border-left:4px solid #005ea6; white-space:pre-wrap; }
    .cause-text { display:none; width:100%; margin-top:6px; padding:6px; border:1px solid #ccc; border-radius:4px; }
    .btn { margin:12px 0; padding:10px 16px; background:#005ea6; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .btn:hover { background:#004080; }
    input, textarea { width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; font-size:14px; }
    .message { margin-top:10px; font-weight:bold; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-storage-compat.js"></script>

  <!-- EmailJS SDK v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
    // Din Firebase-konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyA5NbkUdeOVlAeKO6LR_VgHMUqp2y0aNR8",
      authDomain: "brandrond-5728a.firebaseapp.com",
      projectId: "brandrond-5728a",
      storageBucket: "brandrond-5728a.firebasestorage.app",
      messagingSenderId: "792404228664",
      appId: "1:792404228664:web:158f19bb1114b4e9c044cd",
      measurementId: "G-RSFY1G6HFN"
    };
    // Initiera Firebase
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // Initiera EmailJS
    emailjs.init({ publicKey: '64vIY_pmg15yG6lYv' });
  </script>
</head>
<body>

  <h1>Kontrollrond</h1>
  <div class="tab">
    <button class="tablinks active" onclick="openTab(event,'Smultronet')">Smultronet</button>
    <button class="tablinks" onclick="openTab(event,'Electric')">Electric</button>
  </div>

  <!-- Smultronet-flik -->
  <div id="Smultronet" class="tabcontent active">
    <form id="formSmultronet">
      <label>Datum:</label>
      <input type="date" name="date" required />
      <button type="button" class="btn" id="approve_Smultronet">Godkänn alla</button>
      <div id="list_Smultronet"></div>
      <label>Signatur (namn):</label>
      <input type="text" name="signature" placeholder="Ditt namn" required />
      <button type="submit" class="btn">Skicka in</button>
      <div class="message" id="msg_Smultronet"></div>
    </form>
  </div>

  <!-- Electric-flik -->
  <div id="Electric" class="tabcontent">
    <form id="formElectric">
      <label>Datum:</label>
      <input type="date" name="date" required />
      <button type="button" class="btn" id="approve_Electric">Godkänn alla</button>
      <div id="list_Electric"></div>
      <label>Signatur (namn):</label>
      <input type="text" name="signature" placeholder="Ditt namn" required />
      <button type="submit" class="btn">Skicka in</button>
      <div class="message" id="msg_Electric"></div>
    </form>
  </div>

  <script>
    function openTab(evt, name) {
      document.querySelectorAll('.tabcontent').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tablinks').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      evt.currentTarget.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const questions = [
        {id:1, namn:"Utrymningsplan", instruktion:
`Syfte
Visa utrymningsvägar, larmning och släckutrustning.

Provningsintervall
Var tredje månad.

Resultat
Kontrollera att planen stämmer.`},
        {id:2, namn:"Handbrandsläckare", instruktion:
`Syfte
Släckning av mindre brand.

Provningsintervall
Var tredje månad.

Resultat
1. Kontrollera placering och skylt.
2. Kontrollera manometer (grönt).
3. Kontrollera provmärkning.
4. Kontrollera åtkomlighet.`},
        {id:3, namn:"Ordning och reda vid utrymningsvägar", instruktion:
`Syfte
Minska brandrisk.

Provningsintervall
Var tredje månad.

Resultat
Ta bort brännbart material från utrymningsvägar, trapphus, spisar, entré och värmekällor.`},
        {id:4, namn:"Skyltar för utrymning", instruktion:
`Syfte
Visa bästa utrymningsväg.

Provningsintervall
Var tredje månad.

Resultat
1. Kontrollera synlighet.
2. Kontrollera funktion.`},
        {id:5, namn:"Brandvarnare", instruktion:
`Syfte
Tidigt larm vid brand.

Provningsintervall
En gång i månaden eller vid pip.

Resultat
1. Byt batterier.
2. Testa larmknapp.`},
        {id:6, namn:"Första hjälpen", instruktion:
`Syfte
Första vårdinsats vid olycksfall.

Provningsintervall
Var tredje månad.

Resultat
Kontrollera innehåll i förbandslåda.`},
        {id:7, namn:"Brandfiltar", instruktion:
`Syfte
Kväva brand.

Provningsintervall
2 gånger per år.

Resultat
Kontrollera att filtar är på plats och i gott skick.`},
        {id:8, namn:"Akutpärm", instruktion:
`Syfte
Snabb kontakt med föräldrar vid utrymning.

Provningsintervall
2 gånger per år.

Resultat
Kontrollera namn och telefonnummer.`},
        {id:9, namn:"Elutrustning/värmekällor", instruktion:
`Syfte
Förebygga brandrisk kring elutrustning.

Provningsintervall
Löpande.

Resultat
Kontrollera att ingen elutrustning är övertäckt.`}
      ];

      function render(listId) {
        const c = document.getElementById(listId);
        c.innerHTML = '';
        questions.forEach(q => {
          const cp = document.createElement('div'); cp.className='control-point';
          const lbl = document.createElement('label'); lbl.textContent = q.namn;
          const ib = document.createElement('button'); ib.type='button'; ib.className='link-button'; ib.textContent='Instruktion';
          ib.onclick = () => ins.style.display = ins.style.display==='block' ? 'none' : 'block';
          lbl.appendChild(ib); cp.appendChild(lbl);
          ['godkand','ej_godkand'].forEach(val => {
            const r = document.createElement('input');
            r.type='radio'; r.name=`status_${listId}_${q.id}`; r.value=val;
            if(val==='godkand') r.required=true;
            const rl = document.createElement('label'); rl.style.fontWeight='normal'; rl.appendChild(r);
            rl.appendChild(document.createTextNode(val==='godkand'?' Godkänd':' Ej godkänd'));
            cp.appendChild(rl);
          });
          const ta = document.createElement('textarea'); ta.className='cause-text'; ta.placeholder='Ange orsak...'; cp.appendChild(ta);
          cp.querySelectorAll('input[type=radio]').forEach(radio => {
            radio.onchange = e => {
              if(e.target.value==='ej_godkand'){ ta.style.display='block'; ta.required=true }
              else { ta.style.display='none'; ta.required=false; ta.value='' }
            };
          });
          const ins = document.createElement('div'); ins.className='instructions'; ins.textContent=q.instruktion; cp.appendChild(ins);
          c.appendChild(cp);
        });
      }

      render('list_Smultronet');
      render('list_Electric');

      document.getElementById('approve_Smultronet').onclick = () => {
        document.querySelectorAll('#list_Smultronet input[value="godkand"]').forEach(r=>r.checked=true);
        document.querySelectorAll('#list_Smultronet .cause-text').forEach(ta=>ta.style.display='none');
      };
      document.getElementById('approve_Electric').onclick = () => {
        document.querySelectorAll('#list_Electric input[value="godkand"]').forEach(r=>r.checked=true);
        document.querySelectorAll('#list_Electric .cause-text').forEach(ta=>ta.style.display='none');
      };

      const today = new Date().toISOString().slice(0,10);
      document.querySelectorAll('input[type="date"]').forEach(i=>i.value = today);

      ['Smultronet','Electric'].forEach(tab => {
        const form = document.getElementById('form'+tab);
        const msg  = document.getElementById('msg_'+tab);

        form.addEventListener('submit', async e => {
          e.preventDefault();
          msg.textContent=''; msg.style.color='black';

          const fd = new FormData(form);
          const date = fd.get('date');
          const sig  = fd.get('signature').trim();
          if(!date||!sig){
            msg.style.color='red'; msg.textContent='Datum och signatur krävs.'; return;
          }

          // Bygg CSV
          let csv = 'Flik;Fråga;Status;Orsak\n';
          const cps = document.getElementById('list_'+tab).querySelectorAll('.control-point');
          for(const cp of cps){
            const qtxt = cp.querySelector('label').childNodes[0].textContent;
            const ch   = cp.querySelector('input[type=radio]:checked');
            const status = ch.value==='godkand'?'Godkänd':'Ej godkänd';
            let cause = '';
            if(ch.value==='ej_godkand') cause = cp.querySelector('textarea').value.trim();
            csv += `${tab};${qtxt};${status};${cause}\n`;
          }

          // Ladda upp CSV till Firebase Storage
          try {
            const blob = new Blob([csv],{type:'text/csv'});
            const filename = `rapport_${tab}_${Date.now()}.csv`;
            const ref = storage.ref().child(filename);
            await ref.put(blob);

            // Hämta nedladdningslänk
            const downloadUrl = await ref.getDownloadURL();

            // Skicka mejl med länk
            await emailjs.send('service_1n11tf8','template_jhx4rrr',{
              date: date,
              signature: sig,
              downloadUrl: downloadUrl
            });

            msg.style.color='green';
            msg.textContent='Skickat! Rapporten nås här: ' + downloadUrl;
            form.reset();
            document.querySelectorAll('input[type="date"]').forEach(i=>i.value = today);
            render('list_'+tab);

          } catch(err){
            console.error(err);
            msg.style.color='red';
            msg.textContent='Fel: ' + err.message;
          }
        });
      });
    });
  </script>
</body>
</html>
