<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Sommarledighet 2025 – Närvaroanmälan</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script type="module">
    import emailjs from 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
    window.emailjs = emailjs;
    emailjs.init("f7lLnWl2EadQdRwwt");
  </script>
  <script src="firebase-config.js"></script>
  <script src="email.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  window.onload = function () {
    emailjs.init("64vIY_pmg15yG6lYv");
  };
</script>

  <style>
    body { font-family: "Source Sans Pro", sans-serif; background: #f5f5f5; margin: 2rem; }
        h1 { color: #003366; font-size: 1.5rem; }
    form { background: #fff; padding: 1rem; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background: #ededed; font-weight: 600; }
    .red { background-color: #ffcccc; }
    .blue { background-color: #cce5ff; }
    button { background: #0055a5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
    button:hover { background: #004080; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>

<body>
    <h1>Sommarledighet 2025 – Närvaroanmälan</h1>
  <form id="form">
    <label>Förälders namn:<br><input type="text" id="parentName" required style="width:100%;padding:0.5rem;"></label><br><br>
<label>Ungdomens namn:<br><input type="text" id="ungName" required style="width:100%;padding:0.5rem;"></label><br><br>
    <label>Förälders e-post:<br><input type="email" id="parentEmail" required style="width:100%;padding:0.5rem;"></label><br><br>
    <table id="calendar">
      <thead><tr><th>Datum</th><th>Aktivitet</th><th>Kommer</th><th>Tid</th></tr></thead>
      <tbody></tbody>
    </table>
    <br>
    <button type="submit">Registrera närvaro</button>
  </form>
  <p id="status"></p>

  <script>
    window.loadCalendar = async function() {
      try {
        const snapshot = await firebase.firestore().collection("kalender").orderBy("date").get();
        const tbody = document.querySelector("#calendar tbody");
        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const { date, note, color } = doc.data();
          
          const tr = document.createElement("tr");
          if (color) tr.classList.add(color);
          tr.innerHTML = `
            <td>${date}</td>
            <td>${note}</td>
            <td><input type="checkbox" data-date="${date}" class="kommer"></td>
            <td><input type="time" data-date="${date}" class="tid"></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Fel vid loadCalendar():", err);
      }
    };

    window.addEventListener("load", () => {
      window.loadCalendar();
    });

    document.getElementById("form").addEventListener("submit", async e => {
      e.preventDefault();
      const namn = document.getElementById("parentName").value;
      const email = document.getElementById("parentEmail").value;
      const checkboxar = document.querySelectorAll(".kommer");
      const tider = document.querySelectorAll(".tid");

      const svar = Array.from(checkboxar).map(cb => {
        const date = cb.dataset.date;
        const kommer = cb.checked;
        const tid = Array.from(tider).find(t => t.dataset.date === date)?.value || "";
        return { date, kommer, tid };
      });

      await firebase.firestore().collection("narvaro").add({
        namn, email, svar, tidpunkt: firebase.firestore.Timestamp.now()
      });

      const summary = svar.map(s =>
        `${s.date}: ${s.kommer ? "Kommer" : "Kommer ej"}${s.kommer && s.tid ? " kl " + s.tid : ""}`
      ).join("\n");

      const ok = await skickaBekraftelse(namn, email, summary);
      const statusEl = document.getElementById("status");
      if (ok) {
        statusEl.textContent = "✅ Tack! Din anmälan är inskickad.";
        document.getElementById("form").reset();
      } else {
        statusEl.textContent = "⚠️ Ett fel uppstod vid e-postutskick.";
      }
    });
  </script>
</body>
</html>
