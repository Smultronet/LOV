<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Sommarledighet 2025 - Närvaro</title>
  <link rel="stylesheet" href="https://styleguide.stockholm.se/css/start-style.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: "Source Sans Pro", sans-serif; margin: 2rem; background: #f5f5f5; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background: #ededed; }
    .highlight { background-color: #ffefc1 !important; }
    .red { background-color: #ffcccc !important; }
    .blue { background-color: #cce5ff !important; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Sommarledighet 2025 - Närvaroanmälan</h1>
  <form id="form">
    <label>Förälders namn: <input type="text" id="parentName" required></label><br><br>
    <label>Förälders e-post: <input type="email" id="parentEmail" required></label><br><br>
    <table id="calendar">
      <thead>
        <tr><th>Datum</th><th>Aktivitet</th><th>Kommer</th><th>Tid</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <br>
    <button type="submit">Skicka närvaro</button>
  </form>
  <p id="status"></p>
  <script>
    const db = firebase.firestore();
    const functions = firebase.functions();

    async function loadCalendar() {
      const snapshot = await db.collection("kalender").get();
      const tbody = document.querySelector("#calendar tbody");
      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement("tr");
        if (data.color) tr.classList.add(data.color);

        tr.innerHTML = `
          <td>${data.date}</td>
          <td>${data.note}</td>
          <td><input type="checkbox" data-date="${data.date}" class="kommer"></td>
          <td><input type="time" data-date="${data.date}" class="tid"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("form").addEventListener("submit", async e => {
      e.preventDefault();
      const namn = document.getElementById("parentName").value;
      const email = document.getElementById("parentEmail").value;
      const checked = [...document.querySelectorAll(".kommer")];
      const tider = [...document.querySelectorAll(".tid")];

      const svar = checked.map(input => ({
        date: input.dataset.date,
        kommer: input.checked,
        tid: tider.find(t => t.dataset.date === input.dataset.date)?.value || ""
      }));

      await db.collection("närvaro").add({
        namn, email, svar, tidpunkt: new Date()
      });

      await functions.httpsCallable("skickaBekraftelse")({ namn, email, svar });

      document.getElementById("status").textContent = "✅ Tack! Din anmälan är inskickad.";
      document.getElementById("form").reset();
    });

    loadCalendar();
  </script>
</body>
</html>
