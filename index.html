<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Sommarledighet 2025 – Närvaroanmälan</title>
  <!-- Start.Stockholm CSS -->
  <link rel="stylesheet" href="https://styleguide.stockholm.se/css/start-style.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- EmailJS SDK -->
  <script src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
  <!-- Din Firebase‑konfig -->
  <script src="firebase-config.js"></script>
  <!-- Din EmailJS‑logik -->
  <script src="email.js"></script>
  <style>
    body { font-family: "Source Sans Pro", sans-serif; margin: 2rem; background: #f5f5f5; }
    #debug-box { background: #ffffe0; padding: 0.75rem; border: 1px solid #ddd; margin-bottom: 1rem; white-space: pre-wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background: #ededed; }
    .red { background-color: #ffcccc; }
    .blue { background-color: #cce5ff; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <!-- Synlig debug‑ruta -->
  <div id="debug-box">Debug: startar…</div>

  <h1>Sommarledighet 2025 – Närvaroanmälan</h1>
  <form id="form">
    <label>Förälders namn: <input type="text" id="parentName" required></label><br><br>
    <label>Förälders e-post: <input type="email" id="parentEmail" required></label><br><br>
    <table id="calendar">
      <thead>
        <tr><th>Datum</th><th>Aktivitet</th><th>Kommer</th><th>Tid</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <br>
    <button type="submit">Skicka närvaro</button>
  </form>
  <p id="status"></p>

  <script>
    // Gör loadCalendar tillgänglig globalt
    window.loadCalendar = async function() {
      const debug = document.getElementById("debug-box");
      try {
        debug.textContent = "Hämtar kalender…";
        const snapshot = await firebase.firestore()
          .collection("kalender")
          .orderBy("date")
          .get();
        debug.textContent = "Dokument hittade: " + snapshot.size;

        const tbody = document.querySelector("#calendar tbody");
        tbody.innerHTML = "";  // töm tidigare rader
        snapshot.forEach(doc => {
          const data = doc.data();
          debug.textContent += `\n• ${doc.id} → ${JSON.stringify(data)}`;
          const tr = document.createElement("tr");
          if (data.color) tr.classList.add(data.color);
          tr.innerHTML = `
            <td>${data.date}</td>
            <td>${data.note}</td>
            <td><input type="checkbox" data-date="${data.date}" class="kommer"></td>
            <td><input type="time"    data-date="${data.date}" class="tid"></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Fel vid loadCalendar():", err);
        document.getElementById("debug-box").textContent =
          "Fel vid hämtning: " + err.message;
      }
    };

    // Kör automatisk inläsning när sidan laddas
    window.addEventListener("load", () => {
      document.getElementById("debug-box")
        .textContent = "Firebase initerad, appar: " + firebase.apps.length;
      // Försena anrop så att init hinner färdigt:
      setTimeout(() => window.loadCalendar(), 100);
    });

    // Formulärhantering (oförändrat)
    document.getElementById("form").addEventListener("submit", async e => {
      e.preventDefault();
      const namn  = document.getElementById("parentName").value;
      const email = document.getElementById("parentEmail").value;
      const checkboxar = document.querySelectorAll(".kommer");
      const tider      = document.querySelectorAll(".tid");

      const svar = Array.from(checkboxar).map(cb => {
        const date   = cb.dataset.date;
        const kommer = cb.checked;
        const tid    = Array.from(tider)
                              .find(t => t.dataset.date === date)?.value || "";
        return { date, kommer, tid };
      });

      await firebase.firestore().collection("narvaro").add({
        namn, email, svar, tidpunkt: firebase.firestore.Timestamp.now()
      });

      const summary = svar.map(s =>
        `${s.date}: ${s.kommer ? "Kommer" : "Kommer ej"}`
        + (s.kommer && s.tid ? " kl " + s.tid : "")
      ).join("\n");

      const ok = await skickaBekraftelse(namn, email, summary);
      const statusEl = document.getElementById("status");
      if (ok) {
        statusEl.textContent = "✅ Tack! Din anmälan är inskickad.";
        document.getElementById("form").reset();
      } else {
        statusEl.textContent = "⚠️ Ett fel uppstod vid e-postutskick.";
      }
    });
  </script>
</body>
</html>
