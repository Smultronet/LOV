<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Sommarledighet 2025 - Närvaro</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #calendar { border-collapse: collapse; width: 100%; }
    #calendar th, #calendar td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; }
    #calendar th { background: #f0f0f0; }
    .admin-cell { background: #eaf7ff; min-height: 50px; }
    .parent-cell { min-height: 70px; }
    .parent-cell input[type="time"] { width: 80px; }
    .parent-cell label { display: block; margin-bottom: 4px; }
    #toggleAdmin { margin-bottom: 10px; padding: 8px 12px; }
    #attendanceForm button { margin-top: 10px; padding: 8px 16px; }
    .field-group { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Sommarledighet 2025 - Närvaro</h1>
  <button id="toggleAdmin">Gå till Admin-läge</button>
  <form id="attendanceForm">
    <div class="field-group">
      <label for="parentName">Förälders namn:</label>
      <input type="text" id="parentName" required>
    </div>
    <div class="field-group">
      <label for="parentEmail">Förälders e-post:</label>
      <input type="email" id="parentEmail" required>
    </div>
    <table id="calendar">
      <thead>
        <tr>
          <th>Vecka</th><th>Måndag</th><th>Tisdag</th><th>Onsdag</th><th>Torsdag</th><th>Fredag</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="submit">Skicka svar</button>
  </form>
  <script>
    async function sendData(data) {
      const resp = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await resp.json();
      return result;
    }
    function getDates(start, end) {
      const arr = [], dt = new Date(start);
      while (dt <= end) {
        const day = dt.getDay();
        if (day >= 1 && day <= 5) arr.push(new Date(dt));
        dt.setDate(dt.getDate() + 1);
      }
      return arr;
    }
    function getWeekNumber(d) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      return Math.ceil((((date - yearStart) / 86400000) + 1)/7);
    }
    const startDate = new Date(2025,5,2), endDate = new Date(2025,7,15);
    const allDates = getDates(startDate,endDate), weeks = [];
    allDates.forEach((d,i) => { if (d.getDay() === 1) weeks.push(allDates.slice(i,i+5)); });
    let adminMode = false;
    function renderCalendar() {
      const tbody = document.querySelector('#calendar tbody');
      tbody.innerHTML = '';
      const adminData = JSON.parse(localStorage.getItem('adminData') || '{}');
      const parentData = JSON.parse(localStorage.getItem('parentData') || '{}');
      weeks.forEach(week => {
        const row = document.createElement('tr');
        const weekCell = document.createElement('td');
        weekCell.textContent = getWeekNumber(week[0]);
        row.appendChild(weekCell);
        week.forEach(day => {
          const cell = document.createElement('td');
          const dateStr = day.toISOString().split('T')[0];
          const dateLabel = document.createElement('div');
          dateLabel.textContent = dateStr;
          cell.appendChild(dateLabel);
          if (adminMode) {
            cell.classList.add('admin-cell');
            const info = document.createElement('div');
            info.contentEditable = true;
            info.textContent = adminData[dateStr] || '';
            info.addEventListener('blur', () => {
              adminData[dateStr] = info.textContent;
              localStorage.setItem('adminData', JSON.stringify(adminData));
            });
            cell.appendChild(info);
          } else {
            cell.classList.add('parent-cell');
            const isChecked = parentData[dateStr]?.attender || false;
            const label = document.createElement('label');
            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.checked = isChecked;
            chk.addEventListener('change', () => {
              parentData[dateStr] = { ...parentData[dateStr], attender: chk.checked };
              localStorage.setItem('parentData', JSON.stringify(parentData));
            });
            label.appendChild(chk);
            label.appendChild(document.createTextNode(' Kommer'));
            cell.appendChild(label);
            const timeInput = document.createElement('input');
            timeInput.type = 'time';
            timeInput.value = parentData[dateStr]?.time || '';
            timeInput.addEventListener('change', () => {
              parentData[dateStr] = { ...parentData[dateStr], time: timeInput.value };
              localStorage.setItem('parentData', JSON.stringify(parentData));
            });
            cell.appendChild(timeInput);
          }
          row.appendChild(cell);
        });
        tbody.appendChild(row);
      });
      document.getElementById('toggleAdmin').textContent = adminMode ? 'Gå till Förälder-läge' : 'Gå till Admin-läge';
    }
    document.getElementById('toggleAdmin').addEventListener('click', () => {
      adminMode = !adminMode;
      renderCalendar();
    });
    document.getElementById('attendanceForm').addEventListener('submit', async e => {
      e.preventDefault();
      const parentName = document.getElementById('parentName').value;
      const parentEmail = document.getElementById('parentEmail').value;
      const responses = JSON.parse(localStorage.getItem('parentData') || '{}');
      const summary = Object.entries(responses).map(([d,r]) => `${d}: ${r.attender ? 'Kommer' : 'Kommer ej'}${r.attender && r.time ? ` kl ${r.time}` : ''}`).join('\n');
      const payload = { parentName, parentEmail, summary };
      const result = await sendData(payload);
      alert(result.message);
    });
    renderCalendar();
  </script>
</body>
</html>
